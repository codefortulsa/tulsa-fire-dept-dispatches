{% spaceless %}

<!DOCTYPE html> 
<html>
<head>
    <title>{% block title %}Tulsa Fire Dispatch{% endblock %}</title> 
    {% include "resources.html" %}
    {% load static from staticfiles %}
          
</head>
<body>

    <div id="dispatch_page" class="dispatch_page" data-role="page" >
            
        <div id="tfdd_header" data-role="header" data-position="fixed">
                <div class="tfdd_logo">
                    <img  src="{% static "img/logo.png" %}" alt="Tulsa Fire Dept. Dispatches" />
                </div>
                <a href="{% url about %}"
                    data-icon="info" 
                    data-transition="flip"
                    class="ui-btn-right">About
                </a>       
                <div data-role="navbar" >
                    <ul>
                        <li><a href="{% url dispatches %}" 
                            data-transition="none"
                            >Dispatches</a></li>
                                            
                        {% if user.is_authenticated %}
                        <li><a href="{% url following %}"
                            data-transition="none" 
                            >Following</a></li>
                        
                        <li><a href="{% url settings %}"
                            data-transition="none"
                            >Settings</a>
                        </li>

                        {% else %}
                        <li><a href="{% url login %}"
                            data-transition="none"
                            data-prefetch 
                            >Login</a></li>
                        {% endif %}

                    </ul>
                </div><!-- /navbar -->
        </div><!--  /header -->


        <div data-role="content" >

            <div class='messages'>
                {% comment %}
                {% if user.is_authenticated %}
                    {% if not user.profile.email_verified %}
                    <p>Please verify your email</p>
                    {% endif %}
                    {% if user.profile.phone and not user.profile.phone_verified %}
                    <p>Please verify your phone number</p>
                    {% endif %}
                {% endif %}
                {% endcomment %}
                <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
                </ul>
            </div>    <!-- End of messages -->
            
            
            
            {% block content %}
            <p> Content goes here </p>
            {% endblock %}

        </div>    <!-- End of content -->
    
    </div><!-- End of page -->
    
    {% include "map_page.html" %}


{% if user.is_authenticated %}
<script>

    $(".dispatch_page").bind('pageinit',function() {

        $.disableSelection;
        $("abbr.timeago").timeago();
    
        $("a.dispatch-link").bind('click', function(event) {
            // event.preventDefault();
            dispatch_address = $(this).data('location');
            dispatch_call_type_desc = $(this).data('call_type_desc');
            dispatch_map_page = $(this).data('map_page');
            // $.mobile.changePage("#map_page");
            
        });  
    });//end of page init

    $(".dispatch_page").bind('pagebeforeshow', function() {
        
        dispatch_listview = $("#dispatch_listview", $.mobile.activePage);
        ScheduleUpdateCheck(25000);
    
        last_dispatch = $("#last_dispatch", $.mobile.activePage);
        if (last_dispatch) {
            last_li = $("#list_end", $.mobile.activePage);
        }
    
    });

    $(window).bind('scrollstop', function() {
         window.setTimeout(function() {PositionCheck();},5);
    });


    $("#map_page").bind('pagecreate', function() {
        console.log("pagecreate");
        if (map == null) {
            map = new google.maps.Map(document.getElementById("map_content"), dispatchMapOptions);
            google.maps.event.addListener(map, 'center_changed', function() {
                if (requestHydrants){
                        window.setTimeout(function() {
                            google.maps.event.trigger(map, 'resize');
                            map_center = map.getCenter();
                            getHydrants(dspLocation = map_center, limit = 15, offset = 0);
                        }, 20);
                    }
                    
            });
        }
    });
    
    $("#map_page").bind('pagebeforeshow', function() {        
        console.log('pageshow');
        requestHydrants=false;
        google.maps.event.trigger(map, 'resize'); 

        document.title=dispatch_address;
        $("#dispatch_address").value=dispatch_address; 

        hydrant_markers={};
        tulsaGeocode(dispatch_address, function(dspLocation) {   
            var location_info = dispatch_call_type_desc + "</br>" + dispatch_address + "</br>Map Page: " + dispatch_map_page;;
            console.log(location_info);
            dispatchMarker(dspLocation, location_info);
            getHydrants(dspLocation = dspLocation, limit = 15, offset = 0);                       
            map.setCenter(dspLocation);
            map.setZoom(18);
            requestHydrants=true;    
        });
        document.title=dispatch_address;
        $("#dispatch_address").value=dispatch_address; 
         
    });
    
    $("#map_page").bind('pagebeforehide',function(event,ui) {
        
        console.log("pagebeforehide");
        //remove the dispatch marker
            if(dispatch_marker!=null){
                window.setTimeout(function() {
                dispatch_marker.setMap(null);},
                20);
            }
        //remove hydrant markers 
            for  (marker in hydrant_markers){
                window.setTimeout(function() {
                hydrant_markers[marker].setMap(null);},
                20);
            }        
    });
    
</script>    
{% endif %}

</body>
</html>{% endspaceless %}
